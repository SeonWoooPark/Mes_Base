/**
 * ÏàòÏ£ºÍ¥ÄÎ¶¨ ÌÖåÏù¥Î∏î ÏÑ§Ï†ï
 * 
 * TableTemplateÏóêÏÑú ÏÇ¨Ïö©Ìï† Î™®Îì† ÏÑ§Ï†ïÏùÑ Ï†ïÏùòÌï©ÎãàÎã§.
 */

import React from 'react';
import { TableConfig } from '../templates/TableTemplate/types';
import { Order, OrderStatus, OrderPriority } from './types';
import { orderApi, updateOrderStatus, getCustomers, getProducts } from './api';

// === ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Îß§Ìïë ===
const getStatusText = (status: OrderStatus): string => {
  const statusMap: Record<OrderStatus, string> = {
    [OrderStatus.PENDING]: 'ÎåÄÍ∏∞',
    [OrderStatus.CONFIRMED]: 'ÌôïÏ†ï',
    [OrderStatus.IN_PRODUCTION]: 'ÏÉùÏÇ∞Ï§ë',
    [OrderStatus.READY_TO_SHIP]: 'Ï∂úÌïòÏ§ÄÎπÑ',
    [OrderStatus.SHIPPED]: 'Ï∂úÌïòÏôÑÎ£å',
    [OrderStatus.DELIVERED]: 'ÎÇ©ÌíàÏôÑÎ£å',
    [OrderStatus.CANCELLED]: 'Ï∑®ÏÜå'
  };
  return statusMap[status] || status;
};

// === ÏÉÅÌÉú ÏÉâÏÉÅ Îß§Ìïë ===
const getStatusColor = (status: OrderStatus): { bg: string; text: string } => {
  const colorMap: Record<OrderStatus, { bg: string; text: string }> = {
    [OrderStatus.PENDING]: { bg: '#fff3cd', text: '#856404' },
    [OrderStatus.CONFIRMED]: { bg: '#d1ecf1', text: '#0c5460' },
    [OrderStatus.IN_PRODUCTION]: { bg: '#cce7ff', text: '#004085' },
    [OrderStatus.READY_TO_SHIP]: { bg: '#e7f3ff', text: '#004085' },
    [OrderStatus.SHIPPED]: { bg: '#d4edda', text: '#155724' },
    [OrderStatus.DELIVERED]: { bg: '#d4edda', text: '#155724' },
    [OrderStatus.CANCELLED]: { bg: '#f8d7da', text: '#721c24' }
  };
  return colorMap[status] || { bg: '#f8f9fa', text: '#495057' };
};

// === Ïö∞ÏÑ†ÏàúÏúÑ ÌÖçÏä§Ìä∏ Îß§Ìïë ===
const getPriorityText = (priority: OrderPriority): string => {
  const priorityMap: Record<OrderPriority, string> = {
    [OrderPriority.LOW]: 'ÎÇÆÏùå',
    [OrderPriority.NORMAL]: 'Î≥¥ÌÜµ',
    [OrderPriority.HIGH]: 'ÎÜíÏùå',
    [OrderPriority.URGENT]: 'Í∏¥Í∏â'
  };
  return priorityMap[priority] || priority;
};

// === Ïö∞ÏÑ†ÏàúÏúÑ ÏÉâÏÉÅ Îß§Ìïë ===
const getPriorityColor = (priority: OrderPriority): { bg: string; text: string } => {
  const colorMap: Record<OrderPriority, { bg: string; text: string }> = {
    [OrderPriority.LOW]: { bg: '#f8f9fa', text: '#6c757d' },
    [OrderPriority.NORMAL]: { bg: '#e2f3ff', text: '#0066cc' },
    [OrderPriority.HIGH]: { bg: '#fff3cd', text: '#856404' },
    [OrderPriority.URGENT]: { bg: '#f8d7da', text: '#721c24' }
  };
  return colorMap[priority] || { bg: '#f8f9fa', text: '#495057' };
};

// === ÏàòÏ£ºÍ¥ÄÎ¶¨ ÌÖåÏù¥Î∏î ÏÑ§Ï†ï ===
export const orderTableConfig: TableConfig<Order> = {
  // API ÏÑ§Ï†ï
  api: orderApi,
  
  // ÌÖåÏù¥Î∏î Ïª¨Îüº Ï†ïÏùò
  columns: [
    {
      key: 'orderNumber',
      label: 'ÏàòÏ£ºÎ≤àÌò∏',
      sortable: true,
      width: '140px',
      render: (value, record) => (
        <div>
          <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{value}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            {record.orderDate.toLocaleDateString()}
          </div>
        </div>
      )
    },
    {
      key: 'customerName',
      label: 'Í≥†Í∞ùÎ™Ö',
      sortable: true,
      width: '120px',
      render: (value, record) => (
        <div>
          <div style={{ fontWeight: 'bold' }}>{value}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            {record.customerContact}
          </div>
        </div>
      )
    },
    {
      key: 'productName',
      label: 'Ï†úÌíàÏ†ïÎ≥¥',
      sortable: true,
      render: (value, record) => (
        <div>
          <div style={{ fontWeight: 'bold' }}>{value}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            {record.productCode}
          </div>
        </div>
      )
    },
    {
      key: 'quantity',
      label: 'ÏàòÎüâ',
      align: 'right',
      sortable: true,
      width: '100px',
      render: (value) => value.toLocaleString()
    },
    {
      key: 'unitPrice',
      label: 'Îã®Í∞Ä',
      align: 'right',
      sortable: true,
      width: '100px',
      render: (value) => `‚Ç©${value.toLocaleString()}`
    },
    {
      key: 'totalAmount',
      label: 'Ï¥ùÏï°',
      align: 'right',
      sortable: true,
      width: '120px',
      render: (value) => (
        <span style={{ fontWeight: 'bold', fontSize: '14px' }}>
          ‚Ç©{value.toLocaleString()}
        </span>
      )
    },
    {
      key: 'status',
      label: 'ÏÉÅÌÉú',
      sortable: true,
      width: '100px',
      render: (value) => {
        const colors = getStatusColor(value);
        return (
          <span style={{
            padding: '4px 8px',
            borderRadius: '12px',
            fontSize: '12px',
            fontWeight: 'bold',
            backgroundColor: colors.bg,
            color: colors.text,
            display: 'inline-block',
            minWidth: '60px',
            textAlign: 'center'
          }}>
            {getStatusText(value)}
          </span>
        );
      }
    },
    {
      key: 'priority',
      label: 'Ïö∞ÏÑ†ÏàúÏúÑ',
      sortable: true,
      width: '80px',
      render: (value) => {
        const colors = getPriorityColor(value);
        return (
          <span style={{
            padding: '2px 6px',
            borderRadius: '8px',
            fontSize: '11px',
            fontWeight: 'bold',
            backgroundColor: colors.bg,
            color: colors.text
          }}>
            {getPriorityText(value)}
          </span>
        );
      }
    },
    {
      key: 'requestedDeliveryDate',
      label: 'ÎÇ©Í∏∞ÏöîÏ≤≠Ïùº',
      sortable: true,
      width: '110px',
      render: (value, record) => {
        const today = new Date();
        const deliveryDate = new Date(value);
        const isOverdue = deliveryDate < today && record.status !== OrderStatus.DELIVERED;
        
        return (
          <div style={{ color: isOverdue ? '#dc3545' : '#333' }}>
            <div>{deliveryDate.toLocaleDateString()}</div>
            {isOverdue && record.status !== OrderStatus.CANCELLED && (
              <div style={{ fontSize: '11px', fontWeight: 'bold' }}>
                ÏßÄÏó∞!
              </div>
            )}
          </div>
        );
      }
    }
  ],
  
  // Í≤ÄÏÉâ ÌïÑÎìú Ï†ïÏùò
  searchFields: [
    {
      key: 'customerName',
      label: 'Í≥†Í∞ùÎ™Ö',
      type: 'text',
      placeholder: 'Í≥†Í∞ùÎ™ÖÏúºÎ°ú Í≤ÄÏÉâ'
    },
    {
      key: 'status',
      label: 'ÏÉÅÌÉú',
      type: 'select',
      options: [
        { label: 'ÎåÄÍ∏∞', value: OrderStatus.PENDING },
        { label: 'ÌôïÏ†ï', value: OrderStatus.CONFIRMED },
        { label: 'ÏÉùÏÇ∞Ï§ë', value: OrderStatus.IN_PRODUCTION },
        { label: 'Ï∂úÌïòÏ§ÄÎπÑ', value: OrderStatus.READY_TO_SHIP },
        { label: 'Ï∂úÌïòÏôÑÎ£å', value: OrderStatus.SHIPPED },
        { label: 'ÎÇ©ÌíàÏôÑÎ£å', value: OrderStatus.DELIVERED },
        { label: 'Ï∑®ÏÜå', value: OrderStatus.CANCELLED }
      ]
    },
    {
      key: 'priority',
      label: 'Ïö∞ÏÑ†ÏàúÏúÑ',
      type: 'select',
      options: [
        { label: 'ÎÇÆÏùå', value: OrderPriority.LOW },
        { label: 'Î≥¥ÌÜµ', value: OrderPriority.NORMAL },
        { label: 'ÎÜíÏùå', value: OrderPriority.HIGH },
        { label: 'Í∏¥Í∏â', value: OrderPriority.URGENT }
      ]
    },
    {
      key: 'orderDate',
      label: 'Ï£ºÎ¨∏Ïùº',
      type: 'dateRange'
    }
  ],
  
  // Ìèº ÌïÑÎìú Ï†ïÏùò
  formFields: [
    {
      name: 'customerName',
      label: 'Í≥†Í∞ùÎ™Ö',
      type: 'text',
      required: true,
      placeholder: 'Í≥†Í∞ùÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî'
    },
    {
      name: 'customerContact',
      label: 'Í≥†Í∞ù Ïó∞ÎùΩÏ≤ò',
      type: 'text',
      required: true,
      placeholder: 'Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî'
    },
    {
      name: 'productId',
      label: 'Ï†úÌíà',
      type: 'select',
      required: true,
      options: [
        { label: 'Í∞§Îü≠Ïãú S24 ÏºÄÏù¥Ïä§ (FG2412001)', value: 'prod-001' },
        { label: 'ÏÑºÏÑú Î™®Îìà AÌÉÄÏûÖ (FG2412002)', value: 'prod-002' },
        { label: 'Ïã§Î¶¨ÏΩò ÏõêÎ£å (RM2412001)', value: 'prod-003' },
        { label: 'Î¨¥ÏÑ† Ï∂©Ï†ÑÍ∏∞ 15W (FG2412003)', value: 'prod-004' },
        { label: 'ÏïåÎ£®ÎØ∏ÎäÑ ÌîÑÎ†àÏûÑ (SF2412001)', value: 'prod-005' }
      ]
    },
    {
      name: 'quantity',
      label: 'ÏàòÎüâ',
      type: 'number',
      required: true,
      placeholder: 'ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
      validation: {
        min: 1,
        max: 100000
      }
    },
    {
      name: 'unitPrice',
      label: 'Îã®Í∞Ä',
      type: 'number',
      required: true,
      placeholder: 'Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
      validation: {
        min: 0
      }
    },
    {
      name: 'orderDate',
      label: 'Ï£ºÎ¨∏Ïùº',
      type: 'date',
      required: true
    },
    {
      name: 'requestedDeliveryDate',
      label: 'ÎÇ©Í∏∞ ÏöîÏ≤≠Ïùº',
      type: 'date',
      required: true
    },
    {
      name: 'priority',
      label: 'Ïö∞ÏÑ†ÏàúÏúÑ',
      type: 'select',
      required: true,
      options: [
        { label: 'ÎÇÆÏùå', value: OrderPriority.LOW },
        { label: 'Î≥¥ÌÜµ', value: OrderPriority.NORMAL },
        { label: 'ÎÜíÏùå', value: OrderPriority.HIGH },
        { label: 'Í∏¥Í∏â', value: OrderPriority.URGENT }
      ]
    },
    {
      name: 'memo',
      label: 'ÎπÑÍ≥†',
      type: 'textarea',
      placeholder: 'ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî'
    }
  ],
  
  // Ïï°ÏÖò ÏÑ§Ï†ï
  actions: {
    create: { 
      label: 'ÏàòÏ£º Îì±Î°ù',
      permission: 'orders.create' 
    },
    edit: { 
      label: 'ÏàòÏ†ï',
      permission: 'orders.edit' 
    },
    delete: { 
      label: 'ÏÇ≠Ï†ú',
      permission: 'orders.delete' 
    },
    view: { 
      label: 'ÏÉÅÏÑ∏Î≥¥Í∏∞' 
    },
    custom: [
      {
        key: 'confirm',
        label: 'ÌôïÏ†ï',
        icon: '‚úÖ',
        variant: 'success',
        handler: async (order) => {
          if (order.status !== OrderStatus.PENDING) {
            alert('ÎåÄÍ∏∞ ÏÉÅÌÉúÏùò ÏàòÏ£ºÎßå ÌôïÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            return;
          }
          
          if (window.confirm(`ÏàòÏ£º '${order.orderNumber}'ÏùÑ(Î•º) ÌôïÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            try {
              await updateOrderStatus(order.id, OrderStatus.CONFIRMED);
              window.location.reload(); // Í∞ÑÎã®Ìïú ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
              alert('ÌôïÏ†ï Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
          }
        },
        visible: (order) => order.status === OrderStatus.PENDING,
        permission: 'orders.edit'
      },
      {
        key: 'ship',
        label: 'Ï∂úÌïò',
        icon: 'üöö',
        variant: 'primary',
        handler: async (order) => {
          if (order.status !== OrderStatus.READY_TO_SHIP) {
            alert('Ï∂úÌïòÏ§ÄÎπÑ ÏÉÅÌÉúÏùò ÏàòÏ£ºÎßå Ï∂úÌïòÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            return;
          }
          
          if (window.confirm(`ÏàòÏ£º '${order.orderNumber}'ÏùÑ(Î•º) Ï∂úÌïòÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            try {
              await updateOrderStatus(order.id, OrderStatus.SHIPPED);
              window.location.reload();
            } catch (error) {
              alert('Ï∂úÌïò Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
          }
        },
        visible: (order) => order.status === OrderStatus.READY_TO_SHIP,
        permission: 'orders.edit'
      },
      {
        key: 'cancel',
        label: 'Ï∑®ÏÜå',
        icon: '‚ùå',
        variant: 'danger',
        handler: async (order) => {
          if ([OrderStatus.SHIPPED, OrderStatus.DELIVERED, OrderStatus.CANCELLED].includes(order.status)) {
            alert('Ï∂úÌïò Ïù¥ÌõÑÏùò ÏàòÏ£ºÎäî Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
            return;
          }
          
          if (window.confirm(`ÏàòÏ£º '${order.orderNumber}'ÏùÑ(Î•º) Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            try {
              await updateOrderStatus(order.id, OrderStatus.CANCELLED);
              window.location.reload();
            } catch (error) {
              alert('Ï∑®ÏÜå Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
          }
        },
        visible: (order) => ![OrderStatus.SHIPPED, OrderStatus.DELIVERED, OrderStatus.CANCELLED].includes(order.status),
        permission: 'orders.delete'
      }
    ]
  },
  
  // Í∏∞Î≥∏ Ï†ïÎ†¨
  defaultSort: {
    field: 'orderDate',
    direction: 'desc'
  },
  
  // ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Í≤ΩÎ°ú
  detailPath: '/orders',
  
  // ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ Ï∂îÏ∂ú (ÏÇ≠Ï†ú ÌôïÏù∏Ïö©)
  getItemName: (order) => `${order.orderNumber} (${order.customerName})`,
  
  // Í∂åÌïú ÏÑ§Ï†ï
  permissions: {
    view: 'orders.view',
    create: 'orders.create',
    edit: 'orders.edit',
    delete: 'orders.delete'
  }
};